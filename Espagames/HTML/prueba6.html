<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Espagames</title>
</head>
<body>

<div class="cubo">
  <div class="cubo1">
    <div class="tiempo" id="tiempo">05:00</div>
    <div class="puntos">
      <div class="correcto">C: <span id="correctos">0</span></div>
      <div class="incorrecto">F: <span id="incorrectos">0</span></div>
    </div> 
    <button class="verificacion" onclick="verificarTilde()">VERIFICAR</button>
  </div>

  <div class="cubo2">
    <div class="texto" id="texto"></div>
    <div class="pequeñin">
      <img src="../imagenes/pequenin50.png" class="peque">
    </div>
    <div class="abajo">
      <button class="punto" onclick="seleccionarSigno('.')">.</button>
      <button class="coma" onclick="seleccionarSigno(',')">,</button>
    </div>
  </div>
</div>

<div id="resultado" class="res" style="display:none;">
  <h2>Juego terminado</h2>
  <p>Puntuación final: <span id="puntajeFinal"></span></p>
  <p>Nota: <span id="nota"></span></p>
  <div class="botones">
    <button class="boton2" onclick="location.reload()">Reiniciar</button>
    <button class="boton2" onclick="salir()">Escoger otro</button>
  </div>
</div>

<style>
  @import url("../CSS/prueba6.css");
</style>

<script>
let correctos = 0
let incorrectos = 0
let tiempo = 300
let interval
let indiceSeleccionado = null
let parrafosUsados = []
let parrafoActual

const parrafos = [
  { texto: ["Hoy", null, "fuimos", "al", "parque", null, "y", "jugamos"] },
  { texto: ["María", null, "la", "profesora", "llegó", "tarde", null, "por", "el", "tráfico"] },
  { texto: ["Era", "un", "día", "soleado", null, "decidimos", "ir", "a", "la", "playa", null] },
  { texto: ["El", "perro", "corrió", "rápido", null, "pero", "no", "alcanzó", "la", "pelota", null] },
  { texto: ["Carmen", null, "mi", "mejor", "amiga", null, "ganó", "el", "concurso"] },
  { texto: ["Sin", "embargo", null, "la", "tarea", "no", "estaba", "terminada", null] },
  { texto: ["Pablo", "estudió", "toda", "la", "noche", null, "quería", "aprobar", "el", "examen"] },
  { texto: ["La", "ciudad", "estaba", "tranquila", null, "hasta", "que", "sonó", "la", "alarma", null] }
]

function generarSignos(parrafo) {
  const signos = []
  parrafo.texto.forEach((palabra, i) => {
    if (palabra === null) {
      const siguiente = parrafo.texto[i + 1]
      if (!siguiente) {
        signos.push(".") // si no hay siguiente palabra → punto
      } else if (/^[A-ZÁÉÍÓÚÜÑ]/.test(siguiente)) {
        signos.push(".") // si empieza con mayúscula → punto
      } else {
        signos.push(",") // en cualquier otro caso → coma
      }
    }
  })
  return signos
}

function iniciarTemporizador() {
  interval = setInterval(() => {
    if (tiempo > 0) {
      tiempo--
      const minutos = Math.floor(tiempo / 60)
      const segundos = tiempo % 60
      document.getElementById('tiempo').innerText = 
        `${minutos.toString().padStart(2, '0')}:${segundos.toString().padStart(2, '0')}`
    } else {
      clearInterval(interval)
      finalizarJuego()
    }
  }, 1000)
}

function obtenerParrafoAleatorio() {
  if (parrafosUsados.length === parrafos.length) {
    finalizarJuego()
    return null
  }
  let indice
  do {
    indice = Math.floor(Math.random() * parrafos.length)
  } while (parrafosUsados.includes(indice))
  parrafosUsados.push(indice)

  const p = { ...parrafos[indice] }
  p.signos = generarSignos(p)
  return p
}

function mostrarParrafo() {
  parrafoActual = obtenerParrafoAleatorio()
  if (!parrafoActual) return

  const contenedor = document.getElementById("texto")
  contenedor.innerHTML = ""
  indiceSeleccionado = null
  let huecoIndex = 0
  parrafoActual.texto.forEach((palabra, i) => {
    if (palabra === null) {
      const span = document.createElement("span")
      span.dataset.indice = huecoIndex++
      span.innerHTML = "&nbsp;"
      span.style.display = "inline-block"
      span.style.width = "20px"
      span.style.borderBottom = "1px solid black"
      span.style.cursor = "pointer"
      span.style.textAlign = "center"
      span.onclick = () => seleccionarEspacio(span.dataset.indice)
      contenedor.appendChild(span)
    } else {
      contenedor.append(" " + palabra + " ")
    }
  })
}

function seleccionarEspacio(i) {
  document.querySelectorAll("#texto span").forEach(s => s.classList.remove("seleccionado"))
  const span = document.querySelector(`#texto span[data-indice="${i}"]`)
  span.classList.add("seleccionado")
  indiceSeleccionado = i
}

function seleccionarSigno(signo) {
  if (indiceSeleccionado !== null) {
    const span = document.querySelector(`#texto span[data-indice="${indiceSeleccionado}"]`)
    span.textContent = signo
  }
}

const sonidoCorrecto = new Audio('../sonidos/correct-156911.mp3')
const sonidoIncorrecto = new Audio('../sonidos/error-3-125761.mp3')

function verificarTilde() {
  const signosCorrectos = parrafoActual.signos
  let acierto = true
  document.querySelectorAll("#texto span").forEach((span, idx) => {
    if (span.textContent !== signosCorrectos[idx]) {
      acierto = false
    }
  })

  if (acierto) {
    correctos++
    sonidoCorrecto.play()
  } else {
    incorrectos++
    sonidoIncorrecto.play()
  }

  document.getElementById("correctos").textContent = correctos
  document.getElementById("incorrectos").textContent = incorrectos

  mostrarParrafo()
}

function finalizarJuego() {
  clearInterval(interval)
  const resultadoFinal = correctos - incorrectos
  let nota = "F"
  if (resultadoFinal >= 4) nota = "A"
  else if (resultadoFinal >= 3) nota = "B"
  else if (resultadoFinal >= 2) nota = "C"
  document.getElementById('puntajeFinal').innerText = resultadoFinal
  document.getElementById('nota').innerText = nota
  document.getElementById('resultado').style.display = 'block'
}

function salir() {
  window.location.href = "Espagames.html"
}

window.onload = () => {
  iniciarTemporizador()
  mostrarParrafo()
}
</script>

</body>
</html>
