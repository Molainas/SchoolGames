<!DOCTYPE html>
<html>
<head>
  <title>Espagames</title>    
</head>
<body>

<div class="cubo">
  <div class="cubo1">
    <div class="cubito1">
      <div class="libro">
        <div class="hojas" id="paginaIzquierda"></div>
        <div class="hojas" id="paginaDerecha"></div>
      </div>
    </div>
    <div class="cubito2">
      <button class="marcador" onclick="cambiarColor('protagonista')">
        PROTAGONISTAS <img src="../imagenes/marcador.png" class="img">
      </button>
      <button class="marcador" onclick="cambiarColor('secundario')">
        SECUNDARIOS <img src="../imagenes/marcador.png" class="img">
      </button>
      <button class="marcador" onclick="cambiarColor('antagonista')">
        ANTAGONISTAS <img src="../imagenes/marcador.png" class="img">
      </button>
    </div>
  </div>

  <div class="cubo2">
    <button class="verificacion" onclick="verificarRespuesta()">VERIFICAR</button>
    <div class="puntos">
      <div class="correcto">C: <span id="correctos">0</span></div>
      <div class="incorrecto">F: <span id="incorrectos">0</span></div>
    </div>
    <div class="tiempo" id="tiempo">5:00</div>
  </div>
</div>

<div id="resultado" class="res" style="display:none;">
  <h2>Juego terminado</h2>
  <p>Puntuación final: <span id="puntajeFinal"></span></p>
  <p>Nota: <span id="nota"></span></p>
  <div class="botones">
    <button class="boton2" onclick="location.reload()">Reiniciar</button>
    <button class="boton2" onclick="salir()">Escoger otro</button>
  </div>
</div>

<style>
    @import url("../CSS/prueba9,2.css");
</style>

<script>
let correctos = 0;
let incorrectos = 0;
let tiempo = 300;
let interval;
let colorActual = "protagonista"; // por defecto
let cuentoActual;

// Lista de cuentos con protagonistas, secundarios y antagonistas
const cuentos = [
  {
    texto: "Había una vez una niña llamada Caperucita Roja que vivía en un pequeño pueblo. Un día, su madre le pidió que llevara comida a su abuela. En su camino, Caperucita Roja se encontró con un lobo.",
    protagonistas: ["Caperucita Roja"],
    secundarios: ["madre", "abuela"],
    antagonistas: ["lobo"]
  },
  {
    texto: "Los tres cerditos decidieron construir sus casas. El primero hizo una de paja, el segundo de madera y el tercero de ladrillos. Un lobo llegó soplando para derribar las casas.",
    protagonistas: ["cerditos", "tres cerditos"],
    secundarios: [],
    antagonistas: ["lobo"]
  },
  {
    texto: "Blanca Nieves vivía con su madrastra, la reina malvada. Un día, Blanca Nieves encontró una casita donde vivían siete enanitos que la recibieron con cariño.",
    protagonistas: ["Blanca Nieves"],
    secundarios: ["enanitos", "siete enanitos"],
    antagonistas: ["madrastra", "reina malvada"]
  }
];

// Cargar un cuento nuevo (evita repetir el último)
function nuevoCuento() {
  let nuevo;
  do {
    nuevo = cuentos[Math.floor(Math.random() * cuentos.length)];
  } while (nuevo === cuentoActual);
  cuentoActual = nuevo;
  cargarTexto();
}

// Mostrar texto en las dos páginas
function cargarTexto() {
  const palabras = cuentoActual.texto.split(" ");
  const mitad = Math.ceil(palabras.length / 2);

  const izquierda = document.getElementById("paginaIzquierda");
  const derecha = document.getElementById("paginaDerecha");
  izquierda.innerHTML = "";
  derecha.innerHTML = "";

  palabras.forEach((palabra, i) => {
    const span = document.createElement("span");
    span.classList.add("palabra");
    span.innerText = palabra + " ";
    span.onclick = () => marcarPalabra(span);

    if (i < mitad) {
      izquierda.appendChild(span);
    } else {
      derecha.appendChild(span);
    }
  });
}

function cambiarColor(tipo) {
  colorActual = tipo;
}

function marcarPalabra(span) {
  span.classList.remove("protagonista","secundario","antagonista");
  span.classList.add(colorActual);
}

const sonidoCorrecto = new Audio('../sonidos/correct-156911.mp3');
const sonidoIncorrecto = new Audio('../sonidos/error-3-125761.mp3');

function verificarRespuesta() {
  let aciertos = 0;
  let fallos = 0;

  // Recorremos todas las palabras
  document.querySelectorAll(".palabra").forEach(span => {
    const palabra = span.innerText.trim().replace(/[.,]/g,"").toLowerCase();

    if (cuentoActual.protagonistas.some(p => palabra.includes(p.toLowerCase()))) {
      if (span.classList.contains("protagonista")) aciertos++; else fallos++;
    }
    if (cuentoActual.secundarios.some(p => palabra.includes(p.toLowerCase()))) {
      if (span.classList.contains("secundario")) aciertos++; else fallos++;
    }
    if (cuentoActual.antagonistas.some(p => palabra.includes(p.toLowerCase()))) {
      if (span.classList.contains("antagonista")) aciertos++; else fallos++;
    }
  });

  correctos += aciertos;
  incorrectos += fallos;

  document.getElementById('correctos').innerText = correctos;
  document.getElementById('incorrectos').innerText = incorrectos;

  if (aciertos > 0) sonidoCorrecto.play();
  if (fallos > 0) sonidoIncorrecto.play();

  // Cargar un nuevo cuento después de verificar
  nuevoCuento();
}

function iniciarTemporizador() {
  interval = setInterval(() => {
    if (tiempo > 0) {
      tiempo--;
      const minutos = Math.floor(tiempo / 60);
      const segundos = tiempo % 60;
      document.getElementById('tiempo').innerText = 
        `${minutos.toString().padStart(2, '0')}:${segundos.toString().padStart(2, '0')}`;
    } else {
      clearInterval(interval);
      finalizarJuego();
    }
  }, 1000);
}

function finalizarJuego() {
  clearInterval(interval);
  const resultadoFinal = correctos - incorrectos;
  let nota = "F";
  if (resultadoFinal >= 4) nota = "A";
  else if (resultadoFinal >= 3) nota = "B";
  else if (resultadoFinal >= 2) nota = "C";
  document.getElementById('puntajeFinal').innerText = resultadoFinal;
  document.getElementById('nota').innerText = nota;
  document.getElementById('resultado').style.display = 'block';
}

function salir() {
  window.location.href = "Espagames2.html";
}

window.onload = () => {
  nuevoCuento();   // arranca con un cuento aleatorio
  iniciarTemporizador();
};
</script>

</body>
</html>
