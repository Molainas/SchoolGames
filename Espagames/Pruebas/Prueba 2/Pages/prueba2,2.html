<!DOCTYPE html>
<html>
  <head>
    <title>Espagames</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Dancing+Script&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="cubo">
      <div class="cubo1">
        <!-- Canvas izquierda: referencia -->
        <div class="cuadro">
          <canvas id="canvasRef" width="372" height="525"></canvas>
        </div>

        <!-- Canvas derecha: jugador -->
        <div class="cuadro">
          <canvas id="canvasJugador" width="372" height="525"></canvas>
        </div>
      </div>

      <div class="cubo2">
        <button class="verificacion" onclick="verificarRespuesta()">
          VERIFICAR
        </button>

        <div class="puntos">
          <div class="correcto">C: <span id="correctos">0</span></div>
          <div class="incorrecto">F: <span id="incorrectos">0</span></div>
        </div>

        <img src="../imagenes/pequenin462.png" />
        <div class="tiempo" id="tiempo">05:00</div>
      </div>
    </div>

    <div id="resultado" class="res" style="display: none">
      <h2>Juego terminado</h2>
      <p>Puntuación final: <span id="puntajeFinal"></span></p>
      <p>Nota: <span id="nota"></span></p>
      <div class="botones">
        <button class="boton2" onclick="location.reload()">Reiniciar</button>
        <button class="boton2" onclick="salir()">Escoger otro</button>
      </div>
    </div>

    <style>
      @import url("../CSS/prueba2,2.css");
    </style>

    <script>
      let correctos = 0;
      let incorrectos = 0;
      let tiempo = 300;
      let interval;

      let canvasJugador, ctxJugador;
      let canvasRef, ctxRef;
      let dibujando = false;
      let letraActual = "";

      function iniciarJuego() {
        canvasJugador = document.getElementById("canvasJugador");
        ctxJugador = canvasJugador.getContext("2d");

        canvasRef = document.getElementById("canvasRef");
        ctxRef = canvasRef.getContext("2d");

        // Configuración dibujo libre en el canvas del jugador
        canvasJugador.addEventListener("mousedown", (e) => {
          dibujando = true;
          ctxJugador.beginPath();
          ctxJugador.moveTo(e.offsetX, e.offsetY);
        });

        canvasJugador.addEventListener("mousemove", (e) => {
          if (dibujando) {
            ctxJugador.lineTo(e.offsetX, e.offsetY);
            ctxJugador.stroke();
          }
        });

        canvasJugador.addEventListener("mouseup", () => (dibujando = false));
        canvasJugador.addEventListener("mouseleave", () => (dibujando = false));

        generarNuevaLetra();
        iniciarTemporizador();
      }

      function iniciarTemporizador() {
        interval = setInterval(function () {
          if (tiempo > 0) {
            tiempo--;
            let minutos = Math.floor(tiempo / 60);
            let segundos = tiempo % 60;
            document.getElementById("tiempo").innerText = `${minutos
              .toString()
              .padStart(2, "0")}:${segundos.toString().padStart(2, "0")}`;
          } else {
            clearInterval(interval);
            finalizarJuego();
          }
        }, 1000);
      }

      const sonidoCorrecto = new Audio("../sonidos/correct-156911.mp3");
      const sonidoIncorrecto = new Audio("../sonidos/error-3-125761.mp3");

      function generarNuevaLetra() {
        // Letras posibles
        const letras = ["A", "E", "I", "O", "U"];
        letraActual = letras[Math.floor(Math.random() * letras.length)];

        // Limpiar canvas referencia y jugador
        ctxRef.clearRect(0, 0, canvasRef.width, canvasRef.height);
        ctxJugador.clearRect(0, 0, canvasJugador.width, canvasJugador.height);

        // Dibujar letra cursiva en referencia
        ctxRef.fillStyle = "black";
        ctxRef.font = "italic 200px 'Dancing Script'";
        ctxRef.textAlign = "center";
        ctxRef.textBaseline = "middle";
        ctxRef.fillText(letraActual, canvasRef.width / 2, canvasRef.height / 2);
      }

      function verificarRespuesta() {
        const imagenJugador = ctxJugador.getImageData(
          0,
          0,
          canvasJugador.width,
          canvasJugador.height
        );
        const imagenReferencia = ctxRef.getImageData(
          0,
          0,
          canvasRef.width,
          canvasRef.height
        );

        let coincidencias = 0;
        let totalReferencia = 0;

        for (let i = 0; i < imagenReferencia.data.length; i += 4) {
          const alphaRef = imagenReferencia.data[i + 3];
          const alphaJug = imagenJugador.data[i + 3];

          if (alphaRef > 50) {
            totalReferencia++;
            if (alphaJug > 50) {
              coincidencias++;
            }
          }
        }

        const porcentajeCoincidencia = (coincidencias / totalReferencia) * 100;

        if (porcentajeCoincidencia >= 1) {
          correctos++;
          document.getElementById("correctos").innerText = correctos;
          sonidoCorrecto.play();
        } else {
          incorrectos++;
          document.getElementById("incorrectos").innerText = incorrectos;
          sonidoIncorrecto.play();
        }

        generarNuevaLetra();
      }

      function finalizarJuego() {
        clearInterval(interval);
        const resultadoFinal = correctos - incorrectos;
        let nota;

        if (resultadoFinal >= 20) {
          nota = "A";
        } else if (resultadoFinal >= 10) {
          nota = "B";
        } else if (resultadoFinal >= 5) {
          nota = "C";
        } else {
          nota = "F";
        }

        document.getElementById("puntajeFinal").innerText = resultadoFinal;
        document.getElementById("nota").innerText = nota;
        document.getElementById("resultado").style.display = "block";
      }

      function salir() {
        window.location.href = "Espagames2.html";
      }

      window.onload = iniciarJuego;
    </script>
  </body>
</html>
