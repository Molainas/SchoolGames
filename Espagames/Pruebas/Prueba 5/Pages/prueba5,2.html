<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Espagames</title>
  </head>
  <body>
    <div class="cubo">
      <div class="cubo1">
        <div class="pequeñin">
          <img src="../imagenes/pequenin492.png" />
        </div>
        <div class="pastel">
          <canvas id="juegoCanvas" width="800" height="500"></canvas>
        </div>
      </div>

      <div class="cubo2">
        <div class="correcto">C: <span id="correctos">0</span></div>
        <div class="tiempo" id="tiempo">05:00</div>
        <button class="verificacion" onclick="verificarCortes()">
          VERIFICAR
        </button>
        <div class="incorrecto">F: <span id="incorrectos">0</span></div>
      </div>
    </div>

    <div id="resultado" class="res" style="display: none">
      <h2>Juego terminado</h2>
      <p>Puntuación final: <span id="puntajeFinal"></span></p>
      <p>Nota: <span id="nota"></span></p>
      <div class="botones">
        <button class="boton2" onclick="location.reload()">Reiniciar</button>
        <button class="boton2" onclick="salir()">Escoger otro</button>
      </div>
    </div>

    <style>
      @import url("../CSS/prueba5,2.css");
    </style>

    <script>
      // ==== VARIABLES DE PUNTUACIÓN Y TIEMPO ====
      let correctos = 0;
      let incorrectos = 0;
      let tiempo = 300;
      let interval;

      // ==== PALABRAS CON SÍLABAS ====
      const palabras = [
        "te-le-vi-sor",
        "a-ni-ma-les",
        "ca-ra-co-les",
        "pro-fe-so-res",
        "a-li-men-tos",
      ];
      let palabraActual = palabras[Math.floor(Math.random() * palabras.length)];
      let numSilabas = palabraActual.split("-").length;

      // ==== CANVAS ====
      const canvas = document.getElementById("juegoCanvas");
      const ctx = canvas.getContext("2d");

      let cortes = [];
      let cortando = false;
      let inicio = null;
      let finTemporal = null;
      let pastelDividido = false;

      // ==== DIBUJAR TEXTO DINÁMICO ====
      function dibujarTextoCentrado() {
        const texto = palabraActual.replace(/-/g, "");
        let fontSize = 200;

        // Ajustar el tamaño de la fuente según la longitud del texto
        do {
          ctx.font = `bold ${fontSize}px Cursive`;
          fontSize -= 5;
        } while (ctx.measureText(texto).width > 600 && fontSize > 20);

        ctx.fillStyle = "#8B0000";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(texto, 50 + 700 / 2, 50 + 400 / 2);
      }

      // ==== DIBUJAR PASTEL RECTANGULAR ====
      function dibujarPastelRectangular() {
        const rectX = 50;
        const rectY = 50;
        const rectWidth = 700;
        const rectHeight = 400;

        ctx.fillStyle = "gray";
        ctx.fillRect(rectX, rectY, rectWidth, rectHeight);
        ctx.strokeStyle = "black";
        ctx.lineWidth = 4;
        ctx.strokeRect(rectX, rectY, rectWidth, rectHeight);

        // Palabra sin guiones ajustada
        dibujarTextoCentrado();
      }

      // ==== DIBUJAR CORTES ====
      function dibujarCortes() {
        ctx.strokeStyle = "red";
        ctx.lineWidth = 2;
        cortes.forEach((corte) => {
          ctx.beginPath();
          ctx.moveTo(corte.inicio.x, corte.inicio.y);
          ctx.lineTo(corte.fin.x, corte.fin.y);
          ctx.stroke();
        });
      }

      // ==== DIBUJAR PASTEL SEGÚN CORTES ====
      function dibujarPastelSegunCortes() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        const rectX = 50;
        const rectY = 50;
        const rectWidth = 700;
        const rectHeight = 400;

        let cortesOrdenados = [...cortes].sort(
          (a, b) => a.inicio.x - b.inicio.x
        );

        let secciones = [];
        let xInicio = rectX;

        cortesOrdenados.forEach((corte) => {
          secciones.push({
            x: xInicio,
            y: rectY,
            w: corte.inicio.x - xInicio,
            h: rectHeight,
          });
          xInicio = corte.inicio.x;
        });

        secciones.push({
          x: xInicio,
          y: rectY,
          w: rectX + rectWidth - xInicio,
          h: rectHeight,
        });

        secciones.forEach((sec, i) => {
          const offset = (i % 2 === 0 ? -1 : 1) * 5;
          ctx.fillStyle = i % 2 === 0 ? "gray" : "black";
          ctx.fillRect(sec.x + offset, sec.y, sec.w, sec.h);
          ctx.strokeStyle = "#b5b5b5";
          ctx.lineWidth = 2;
          ctx.strokeRect(sec.x + offset, sec.y, sec.w, sec.h);
        });

        // Texto centrado (sin guiones)
        dibujarTextoCentrado();
      }

      // ==== REDIBUJAR ====
      function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        if (pastelDividido) {
          dibujarPastelSegunCortes();
        } else {
          dibujarPastelRectangular();
          dibujarCortes();

          if (cortando && finTemporal) {
            ctx.strokeStyle = "rgba(255,0,0,0.7)";
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(inicio.x, inicio.y);
            ctx.lineTo(finTemporal.x, finTemporal.y);
            ctx.stroke();
          }
        }
      }

      // ==== ANIMAR CORTE ====
      function animarCorte(inicio, fin) {
        let progreso = 0;

        function paso() {
          draw();
          ctx.strokeStyle = "red";
          ctx.lineWidth = 2;
          ctx.beginPath();
          ctx.moveTo(inicio.x, inicio.y);
          ctx.lineTo(
            inicio.x + (fin.x - inicio.x) * progreso,
            inicio.y + (fin.y - inicio.y) * progreso
          );
          ctx.stroke();

          progreso += 0.05;
          if (progreso <= 1) {
            requestAnimationFrame(paso);
          } else {
            cortes.push({ inicio, fin });
            draw();
          }
        }

        requestAnimationFrame(paso);
      }

      // ==== EVENTOS DE CORTE ====
      canvas.addEventListener("mousedown", (e) => {
        if (pastelDividido) return;
        cortando = true;
        const rect = canvas.getBoundingClientRect();
        inicio = { x: e.clientX - rect.left, y: e.clientY - rect.top };
        finTemporal = inicio;
      });

      canvas.addEventListener("mousemove", (e) => {
        if (pastelDividido || !cortando) return;
        const rect = canvas.getBoundingClientRect();
        finTemporal = { x: e.clientX - rect.left, y: e.clientY - rect.top };
        draw();
      });

      canvas.addEventListener("mouseup", (e) => {
        if (pastelDividido) return;
        if (cortando) {
          cortando = false;
          const rect = canvas.getBoundingClientRect();
          const fin = { x: e.clientX - rect.left, y: e.clientY - rect.top };
          finTemporal = null;
          animarCorte(inicio, fin);
        }
      });

      const sonidoCorrecto = new Audio("../sonidos/correct-156911.mp3");
      const sonidoIncorrecto = new Audio("../sonidos/error-3-125761.mp3");

      function verificarCortes() {
        const cortesValidos = cortes.length;
        const necesario = numSilabas - 1;

        if (cortesValidos === necesario) {
          correctos++;
          document.getElementById("correctos").innerText = correctos;
          sonidoCorrecto.play();

          // Pasar directamente a la siguiente palabra
          setTimeout(() => siguientePalabra(), 1000);
        } else {
          incorrectos++;
          document.getElementById("incorrectos").innerText = incorrectos;
          sonidoIncorrecto.play();

          // También pasar a la siguiente palabra aunque esté mal
          setTimeout(() => siguientePalabra(), 1000);
        }
      }

      function siguientePalabra() {
        palabraActual = palabras[Math.floor(Math.random() * palabras.length)];
        numSilabas = palabraActual.split("-").length;
        cortes = [];
        pastelDividido = false; // siempre false
        draw();
      }

      // ==== TEMPORIZADOR ====
      function iniciarTemporizador() {
        interval = setInterval(() => {
          if (tiempo > 0) {
            tiempo--;
            const minutos = Math.floor(tiempo / 60);
            const segundos = tiempo % 60;
            document.getElementById("tiempo").innerText = `${minutos
              .toString()
              .padStart(2, "0")}:${segundos.toString().padStart(2, "0")}`;
          } else {
            clearInterval(interval);
            finalizarJuego();
          }
        }, 1000);
      }

      function finalizarJuego() {
        clearInterval(interval);
        const resultadoFinal = correctos - incorrectos;
        let nota = "F";
        if (resultadoFinal >= 4) nota = "A";
        else if (resultadoFinal >= 3) nota = "B";
        else if (resultadoFinal >= 2) nota = "C";

        document.getElementById("puntajeFinal").innerText = resultadoFinal;
        document.getElementById("nota").innerText = nota;
        document.getElementById("resultado").style.display = "block";
      }

      function salir() {
        window.location.href = "Espagames2.html";
      }

      // ==== INICIO ====
      window.onload = () => {
        iniciarTemporizador();
        draw();
      };
    </script>
  </body>
</html>
